<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<HTML lang="ja">
<HEAD>
 <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
 <META http-equiv="Content-Script-Type" content="text/javascript">
 <META http-equiv="Content-Style-Type" content="text/css">
 <LINK rel="stylesheet" type="text/css" href="kawari.css">
 <TITLE>華和梨インラインスクリプト リファレンス</TITLE>
<STYLE type="text/css">
<!--
TABLE.command_table {
	padding: 8px;
	border-width: 2px;
	border-color: #ffa0a0;
	border-style: solid;
}
TABLE.command_table CAPTION{
	background: #ffa0a0;
}
TABLE.command_table TR.genre{
 font-style: normal; font-weight: bold; color: black;
 
}

TABLE.command {
	padding: 8px;
}
TABLE.command CAPTION{
 text-align: left;
 padding: 0px 0px 0px 1em;
 margin: 3ex 0px 1ex 0px;
 background: #ffa0a0;
}
 -->
</STYLE>
<BODY text="black" bgcolor="white">

  <H1>プログラマブル準AIモジュール "華和梨" 
    インラインスクリプト リファレンスマニュアル</H1>
<DIV align="right">
  <P>
    2005/07/03<BR>
    Phase 8.2.3
  </P><P>
    華和梨開発チーム :<BR>
    NAKAUE.T (Meister), 偽Meister (夢乃), さとー, 酔狂, さくらのにえ
  </P>
</DIV>

<H2>Index</H2>

<A href="index.html" class="toindex">← back</A>
<BR>

<BLOCKQUOTE>
<A href="#gaiyou">1. 概要</A><BR>
<A href="#shoshiki">2. 書式</A><BR>
<A href="#hyouka">3. 評価、戻り値、真偽の判定</A><BR>
<A href="#command">4. コマンド</A><BR>
　<A href="#commandlist">4.1. コマンド一覧</A><BR>
　<A href="#commandref">4.2. コマンドリファレンス</A><BR>
　　<A href="#syntax">4.2.1. 構文</A><BR>
　　<A href="#dic-handle">4.2.2. コマンド-辞書操作</A><BR>
　　<A href="#file-io">4.2.3. コマンド-ファイル操作</A><BR>
　　<A href="#counter">4.2.4. コマンド-カウンタ</A><BR>
　　<A href="#string">4.2.5. コマンド-文字列操作</A><BR>
　　<A href="#saori">4.2.6. コマンド-SAORI</A><BR>
　　<A href="#communicate">4.2.7. コマンド-コミュニケート機能</A><BR>
　　<A href="#output">4.2.8. コマンド-出力</A><BR>
　　<A href="#aux">4.2.9. コマンド-補助機能</A><BR>
　　<A href="#othercmd">4.2.10. コマンド-その他</A><BR>
<A href="#appendix">Appendix</A><BR>
　<A href="#apdx1">I. インラインスクリプトの追加方法</A><BR>
　<A href="#apdx2">II. 注釈</A><BR>
</BLOCKQUOTE>

<A name="gaiyou"></A>
<H2>1. 概要</H2>

<P>
華和梨インラインスクリプト(KIS : Kawari Inline Script)は、
華和梨の辞書ファイル中で使用できる簡易言語です。
インラインスクリプトを使用することにより、
華和梨実行中に辞書へ単語を追加したり、
本体から通知されるイベントに応じた処理を行ったりすることができます。
</P>

<A name="shoshiki"></A>
<H2>2. 書式</H2>

<P>
インラインスクリプトは、単語中に「<SPAN class="tt">$(～)</SPAN>」
で囲んで記述します。一つの「$(～)」で囲まれた塊を、「インラインスクリプトブロック」と呼びます。
一つのブロックの中には、複数の文を記述できます。
文と文の間は「<SPAN class="tt">;</SPAN>」(セミコロン)で区切ります。
一つの文は、一つのコマンドと零個以上の引数から構成されます。
コマンド、セミコロン、各引数の間は、それぞれ一つ以上の空白で区切ります。
</P>

<PRE>
  インラインスクリプト:
    ブロック

  ブロック:
    $(文)
    $(文 ; 文 ; …)

  文:
    コマンド名 引数1 引数2 …
</PRE>

<A name="hyouka"></A>
<H2>3. 評価、戻り値、真偽の判定</H2>

<P>
ブロックがイベント呼び出し、発話要求等を通じて華和梨に解釈されることを、
「評価」と呼びます。ブロックは評価されると、「戻り値」を返します。
戻り値は一つの文字列で、どのような戻り値を返すかはコマンドによって異なります。
コマンドによっては、つねに「""」(空文字列)を返すこともあります。
</P><P>
ブロックが複数の文から成る場合、ブロックの戻り値は、
ブロック中の全ての文の戻り値を順に繋げたものです。
なお、ブロックから戻り値を返したくない場合、
<A href="#silent">silent</A>コマンドを使用すれば抑制できます。
</P><P>
華和梨が戻り値を評価し、ブール代数における「真」か「偽」かを判定する際、
次のような基準で判定します。
</P>
<UL>
	<LI>空文字列「""」、文字列「"0"」、文字列「"false"」ならば「偽」</LI>
	<LI>「偽」以外ならば「真」("ほげ"、"1"、"true"、" "(空白)...)</LI>
</UL>
<P>
この真偽の判定は、後述する構文コマンド、関数コマンド問わず共通です。
コマンドを独自に追加する場合、真偽の判定はこの基準に合わせて下さい。
</P>

<A name="command"></A>
<H2>4. コマンド</H2>

<P>
コマンドは大きく分けて、<A href="#if">if</A>コマンドや
<A href="#while">while</A>コマンドのような「構文コマンド」と、
<A href="#adddict">adddict</A>コマンドや<A href="#date">date</A>コマンドの
ような「関数コマンド」の二つに分類できます。
構文コマンドは与えられた条件の真偽に従い、処理の流れを制御します。一方、
関数コマンドは与えられた引数に従い、実際の処理を行います。
<SUP><FONT size="-1"><A href="#ref1">*1</A></FONT></SUP>
<SUP><FONT size="-1"><A href="#ref2">*2</A></FONT></SUP>
</P><P>
混同する恐れの無い場合、構文コマンドは「構文」、関数コマンドは単に
「コマンド」と呼ぶことがあります。
</P>

<A name="commandlist"></A>
<H3>4.1. コマンド一覧</H3>

<DIV align="center">

<TABLE class="command_table" width="80%">
<CAPTION>構文コマンド</CAPTION>
<TR><TD><A href="#if">if</A></TD><TD>条件判断</TD></TR>
<TR><TD><A href="#foreach">foreach</A></TD><TD>指定エントリ中のすべての単語に対しコマンド実行</TD></TR>
<TR><TD><A href="#loop">loop</A></TD><TD>指定回数ループ</TD></TR>
<TR><TD><A href="#silent">silent</A></TD><TD>ブロックの出力を抑制</TD></TR>
<TR><TD><A href="#until">until</A></TD><TD>条件が成立するまでループ</TD></TR>
<TR><TD><A href="#while">while</A></TD><TD>条件が成立している間ループ</TD></TR>
<TR><TD><A href="#break">break</A></TD><TD>ループからの脱出</TD></TR>
<TR><TD><A href="#continue">continue</A></TD><TD>ループ先頭に戻る</TD></TR>
<TR><TD><A href="#NULL">NULL</A></TD><TD>空文字列</TD></TR>
<TR><TD><A href="#randomselect">?</A></TD><TD>ランダム選択</TD></TR>
<TR><TD><A href="#function">function</A></TD><TD>関数定義</TD></TR>
<TR><TD><A href="#rmfunc">rmfunc</A></TD><TD>ユーザ定義関数の削除</TD></TR>
<TR><TD><A href="#return">return</A></TD><TD>関数からの脱出</TD></TR>
</TABLE>

<BR clear="all">

<TABLE class="command_table" width="80%">
<CAPTION>関数コマンド</CAPTION>
<TR class="genre"><TD colspan="2">辞書操作</TD></TR>
<TR><TD><A href="#dictcommon">共通事項</TD><TD>辞書操作コマンドに共通の特徴</TD></TR>
<TR><TD><A href="#set">set</A></TD><TD>エントリに単語をセット</TD></TR>
<TR><TD><A href="#setstr">setstr</A></TD><TD>エントリに文字列をセット</TD></TR>
<TR><TD><A href="#adddict">adddict</A></TD><TD>エントリに単語を追加</TD></TR>
<TR><TD><A href="#adddictstr">adddictstr</A></TD><TD>エントリに文字列を追加</TD></TR>
<TR><TD><A href="#push">push</A></TD><TD>エントリに単語を追加</TD></TR>
<TR><TD><A href="#pushstr">pushstr</A></TD><TD>エントリに文字列を追加</TD></TR>
<TR><TD><A href="#unshift">unshift</A></TD><TD>エントリの先頭に単語を挿入</TD></TR>
<TR><TD><A href="#unshiftstr">unshiftstr</A></TD><TD>エントリの先頭に文字列を挿入</TD></TR>
<TR><TD><A href="#insert">insert</A></TD><TD>エントリ内の指定した位置に単語を挿入</TD></TR>
<TR><TD><A href="#insertstr">insertstr</A></TD><TD>エントリ内の指定した位置に文字列を挿入</TD></TR>
<TR><TD><A href="#get">get</A></TD><TD>エントリ中の単語を得る</TD></TR>
<TR><TD><A href="#getcode">getcode</A></TD><TD>エントリを評価せずに参照</TD></TR>
<TR><TD><A href="#getrandom">getrandom</A></TD><TD>エントリ中のいずれかの単語を得る</TD></TR>
<TR><TD><A href="#pop">pop</A></TD><TD>エントリ最後尾の単語を返し、エントリから削除</TD></TR>
<TR><TD><A href="#popcode">popcode</A></TD><TD>エントリ最後尾の単語を評価せずに返し、エントリから削除</TD></TR>
<TR><TD><A href="#shift">shift</A></TD><TD>エントリ先頭の単語を返し、エントリから削除</TD></TR>
<TR><TD><A href="#shiftcode">shiftcode</A></TD><TD>エントリ先頭の単語を評価せずに返し、エントリから削除</TD></TR>
<TR><TD><A href="#clear">clear</A></TD><TD>エントリから単語を削除</TD></TR>
<TR><TD><A href="#cleartree">cleartree</A></TD><TD>エントリツリーから単語を削除</TD></TR>

<TR><TD><A href="#size">size</A></TD><TD>エントリ中の単語数を数える</TD></TR>

<TR><TD><A href="#find">find</A></TD><TD>エントリ中の単語の最初の位置を得る</TD></TD>
<TR><TD><A href="#rfind">rfind</A></TD><TD>エントリ中の単語の最後の位置を得る</TD></TD>
<TR><TD><A href="#copy">copy</A></TD><TD>エントリ内容のコピー</TD></TD>
<TR><TD><A href="#copytree">copytree</A></TD><TD>エントリ内容をエントリ構造ごとコピー</TD></TD>
<TR><TD><A href="#move">move</A></TD><TD>エントリ内容の移動</TD></TD>
<TR><TD><A href="#movetree">movetree</A></TD><TD>エントリ内容をエントリ構造ごと移動</TD></TD>
<TR><TD><A href="#listsub">listsub</A></TD><TD>サブエントリのリストを得る</TD></TD>
<TR><TD><A href="#listtree">listtree</A></TD><TD>エントリツリー全体のリストを得る</TD></TD>
<TR><TD><A href="#writeprotect">writeprotect</A></TD><TD>エントリを書き込み不可にする</TD></TD>

<TR class="genre"><TD colspan="2">ファイル操作</TD></TR>
<TR><TD><A href="#save">save</A></TD><TD>エントリをファイルに保存</TD></TR>
<TR><TD><A href="#savecrypt">savecrypt</A></TD><TD>エントリをファイルに暗号化して保存</TD></TR>
<TR><TD><A href="#load">load</A></TD><TD>華和梨形式辞書ファイルを読み込む</TD></TR>
<TR><TD><A href="#textload">textload</A></TD><TD>テキストファイルを読み込む</TD></TR>
<TR><TD><A href="#textappend">textappend</A></TD><TD>テキストファイルを追記</TD></TR>
<TR><TD><A href="#textsave">textsave</A></TD><TD>テキストファイルを保存</TD></TR>
<TR><TD><A href="#readdir">readdir</A></TD><TD>ディレクトリを読み込む</TD></TR>
<TR><TD><A href="#cncpath">cncpath</A></TD><TD>パス名をシステムで使えるようにする</TD></TR>
<TR><TD><A href="#dirname">dirname</A></TD><TD>パス名からディレクトリ名部分を切り出す</TD></TR>
<TR><TD><A href="#filename">filename</A></TD><TD>パス名からファイル名部分を切り出す</TD></TR>
<TR><TD><A href="#isexist">isexist</A></TD><TD>指定ファイルが存在するか判定する</TD></TR>
<TR><TD><A href="#isdir">isdir</A></TD><TD>指定ファイルがディレクトリか判定する</TD></TR>
<TR><TD><A href="#isfile">isfile</A></TD><TD>指定ファイルが通常ファイルか判定する</TD></TR>

<TR class="genre"><TD colspan="2">カウンタ</TD></TR>
<TR><TD><A href="#dec">dec</A></TD><TD>指定エントリの単語を数字と見なし減算する</TD></TR>
<TR><TD><A href="#inc">inc</A></TD><TD>指定エントリの単語を数字と見なし加算する</TD></TR>
<!--
<TR class="genre"><TD colspan="2">評価・比較</TD></TR>
<TR><TD><A href="#expr">expr</A></TD><TD>式を評価する</TD></TR>
<TR><TD><A href="#test">test</A></TD><TD>値を比較する</TD></TR>
-->

<TR class="genre"><TD colspan="2">文字列操作</TD></TR>
<TR><TD><A href="#length">length</A></TD><TD>文字列の長さを得る</TD></TR>
<TR><TD><A href="#match">match</A></TD><TD>ある部分文字列が現れる最初の位置を得る</TD></TR>
<TR><TD><A href="#rmatch">rmatch</A></TD><TD>ある部分文字列が現れる最後の位置を得る</TD></TR>
<TR><TD><A href="#match_at">match_at</A></TD><TD>ある部分文字列が指定位置に存在するか否か判定する</TD></TR>
<TR><TD><A href="#substr">substr</A></TD><TD>部分文字列を得る</TD></TR>
<TR><TD><A href="#char_at">char_at</A></TD><TD>指定位置の文字を得る</TD></TR>
<TR><TD><A href="#sub">sub</A></TD><TD>マッチする最初の文字列を置き換える</TD></TR>
<TR><TD><A href="#gsub">gsub</A></TD><TD>マッチする全ての文字列を置き換える</TD></TR>
<TR><TD><A href="#rsub">rsub</A></TD><TD>マッチする最後尾の文字列を置き換える</TD></TR>
<TR><TD><A href="#tr">tr</A></TD><TD>文字を置き換える</TD></TR>
<TR><TD><A href="#reverse">reverse</A></TD><TD>文字列を逆順にする</TD></TR>
<TR><TD><A href="#tolower">tolower</A></TD><TD>アルファベットを小文字にする</TD></TR>
<TR><TD><A href="#toupper">toupper</A></TD><TD>アルファベットを大文字にする</TD></TR>
<TR><TD><A href="#chr">chr</A></TD><TD>指定した文字コードの一文字を返す</TD></TR>
<TR><TD><A href="#split">split</A></TD><TD>文字列を区切り文字で分解</TD></TR>
<TR><TD><A href="#join">join</A></TD><TD>区切り文字で文字列を結合</TD></TR>
<TR><TD><A href="#compare">compare</A></TD><TD>文字列を比較する</TD></TR>

<TR class="genre"><TD colspan="2">SAORI</TD></TR>
<TR><TD><A href="#saoriregist">saoriregist</A></TD><TD>SAORIを登録する</TD></TR>
<TR><TD><A href="#saorierase">saorierase</A></TD><TD>SAORIの登録を解除する</TD></TR>
<TR><TD><A href="#saorilist">saorilist</A></TD><TD>登録中のSAORI一覧を返す</TD></TR>
<TR><TD><A href="#callsaori">callsaori</A></TD><TD>登録したSAORIを呼び出す</TD></TR>
<TR><TD><A href="#callsaorix">callsaorix</A></TD><TD>登録したSAORIを呼び出す(高機能版)</TD></TR>

<TR class="genre"><TD colspan="2">コミュニケート機能</TD></TR>
<TR><TD><A href="#communicate">communicate</A></TD><TD>あるエントリの全ての単語を評価し、値から一つをランダムで選ぶ</TD></TR>
<TR><TD><A href="#matchall">matchall</A></TD><TD>全てのキーワードに対してマッチング</TD></TR>

<TR class="genre"><TD colspan="2">出力</TD></TR>
<TR><TD><A href="#echo">echo</A></TD><TD>引数を空白文字で接続して返す</TD></TR>
<TR><TD><A href="#encode_entryname">encode_entryname</A></TD><TD>エントリ名に使用できる名前に変換</TD></TR>
<TR><TD><A href="#escape">escape</A></TD><TD>引数内のさくらスクリプトをエスケープする</TD></TR>

<TR class="genre"><TD colspan="2">補助機能</TD></TR>
<TR><TD><A href="#entry">entry</A></TD><TD>エントリを呼び出す</TD></TR>
<TR><TD><A href="#entrycount">entrycount</A></TD><TD>エントリ総数を返す</TD></TR>
<TR><TD><A href="#eval">eval</A></TD><TD>単語を再評価</TD></TR>
<TR><TD><A href="#urllist">urllist</A></TD><TD>SHIORI/2.5形式のおすすめリストを出力する</TD></TR>
<TR><TD><A href="#wordcount">wordcount</A></TD><TD>単語総数を返す</TD></TR>
<TR><TD><A href="#xargs">xargs</A></TD><TD>引数を展開して実行する</TD></TR>

<TR class="genre"><TD colspan="2">その他</TD></TR>
<TR><TD><A href="#rccharset">rccharset</A></TD><TD>メッセージ文字セット設定</TD></TR>
<TR><TD><A href="#date">date</A></TD><TD>日時を指定フォーマットで返す</TD></TR>
<TR><TD><A href="#mktime">mktime</A></TD><TD>日時を通算経過秒数に変換する</TD></TR>
<TR><TD><A href="#getenv">getenv</A></TD><TD>環境変数の内容を返す</TD></TR>
<TR><TD><A href="#help">help</A></TD><TD>KISコマンドオンラインヘルプ</TD></TR>
<TR><TD><A href="#logfile">logfile</A></TD><TD>ログファイルを指定する</TD></TR>
<TR><TD><A href="#loglevel">loglevel</A></TD><TD>ログに取る種類を決める</TD></TR>
<TR><TD><A href="#logprint">logprint</A></TD><TD>ログに出力する</TD></TR>
<TR><TD><A href="#debugger">debugger</A></TD><TD>幸水デバッガのON/OFF</TD></TR>
<TR><TD><A href="#rand">rand</A></TD><TD>ランダムな整数を返す</TD></TR>
<TR><TD><A href="#srand">srand</A></TD><TD>乱数の種を設定する</TD></TR>
<TR><TD><A href="#securitylevel">securitylevel</A></TD><TD>セキュリティレベルの指定</TD></TR>
<TR><TD><A href="#ver">ver</A></TD><TD>バージョン番号取得</TD></TR>
</TABLE>
</DIV>

<A name="commandref"></A>
<H3>4.2. コマンドリファレンス</H3>
<A name="syntax"></A>
<H4>4.2.1. 構文</H4>

<TABLE class="command" width="100%">
<CAPTION>
	break<A name="break"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(break)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		loop、until、while、foreach等のループ構文から抜け出す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  # dataエントリ内の単語を調べ、「END」だったらループから抜ける
  $(
    setstr @count 0;
    loop $(size data) $(
      if $[ $data[${@count}] == "END" ] $(
        break;
      ) else $(
        inc @count;
      );
    );
    get data[${@count}];
  )
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	continue<A name="continue"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(continue)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		loop、until、while、foreach等のループ構文中で、
		現在のループ処理を終了し、次のループ処理に入る
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  # dataエントリの単語で「ゴースト」を含む単語のみdata2エントリにコピー
  $(
    loop $(size data) $(
        setstr @count ${-1};
        echo $data[${@count}];
        if $[ $data[${@count} !~ "ゴースト" ] $(
            continue;
        );
        pushstr data2 $data[${@count}];
    );
  )
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	function<A name="function"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(function 関数名 関数の定義)
		$(function 関数名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		引数が2つの場合なし
		引数が1つの場合、関数定義内容の文字列表現
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	  <P>
	    関数コマンドを定義する。
	    関数定義中、@argエントリが引数として使用できる。$@arg[0]は関数名で、
	    引数は$@arg[1]からとなる。
	    関数定義全体の戻り値が、関数の戻り値となる。
	  </P><P>
	    組み込み関数と同じ名前のコマンド(ただし、構文コマンドは不可)も定義可能。
	    同名の組み込みコマンドとユーザ定義コマンドが存在した場合、
	    ユーザ定義コマンドが優先して呼び出される。
	    その場合、先頭に<SPAN class="tt">"."</SPAN>を付けて呼び出すことにより、
	    元の組み込みコマンドを強制的に呼び出すことができる。
	  </P><P>
	    引数が関数名だけだった場合、関数定義の内容の文字列表現が返る。
	    この戻り値は、関数定義内容をエントリに記述し、
	    getcodeコマンドでエントリを呼び出した場合と等価である。
	  </P>
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # エントリにセットした値を戻り値とする関数を定義する
  function tset $(
    # 引数が2個でなければ何もしない
    if $[ $(size @arg) != 3 ] $(return "");
    set $@arg[1] $(getcode @arg[2]);
    get @arg[2];
  );
  # ユーザ定義関数tsetの定義を、funcdefエントリに格納
  set funcdef $(function tset);
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	if<A name="if"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(if 条件文 真の場合の文)<BR>
		$(if 条件文 真の場合の文 else 偽の場合の文)<BR>
		$(if 条件文 真の場合の文 else if 条件文2 …)<BR>
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		真の場合の文、または偽の場合の文の戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		条件文の真偽に応じ、真の場合の文、
		または偽の場合の文を実行する。
		else if節は何段でもつなげる事ができる。<BR>
		elseなどのコマンドの前後には必ず空白文字・改行文字が必要。
<!--		分からないだろうこれは：なお、KISには「ぶら下がりelse」の問題は存在しない。 -->
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例1
  $(if $[ ${mode} == "Y" ] "\h\はい\e" else "\hいいえ\e")
    # modeエントリの内容で検索したものが"Y"の場合、「はい」と表示
    # それ以外の場合は「いいえ」と表示

例2
  $(if "true" $(set a "1" ; set b "2") )
    # aエントリの内容は1、bエントリの内容は2になる
    # マルチステートメント(複文)を使っている

例3
  =dict
  a : 1
  b : 2
  =end
  
  =kis
  if $[ ${a} == "1" ] $(
    if $[ ${b} == "2"] $(
      echo "あたり";
    ) else $(
      echo "はずれ";
    );
  ) else $(
    echo "はずれ";
  );
  =end
  # if文の入れ子の例
  # 「あたり」と表示される
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	foreach<A name="foreach"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(foreach エントリ1 エントリ2 文1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文1をエントリ2内の全単語について評価した結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ2内の全単語を順にエントリ1にセットし、そのつど文1を評価する。
		文1に置換ブロックを用いる場合には、$()等で囲む。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(set N 0 ; foreach i npw $(echo ${i}様、 ; inc N) ; echo 以上${N}名)
  # npwエントリ内の人名を全て「様」をつけて呼び、最後に「以上n名」と
  # 人数を表示
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	loop<A name="loop"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(loop 回数 文1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文1の戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		指定した回数だけ、文1を繰り返し評価する。
		回数、文1に置換ブロックを用いる場合には、$()等で囲む。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(loop 10 "tick!")
  # 「tick!」と10回表示される
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	return<A name="return"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(return 戻り値)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		指定した戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		関数から指定した戻り値で直ちに抜ける。戻り値は省略可能で、
		省略した場合、それまでの関数の出力が関数の戻り値となる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  function じゃんけん $(
    if $[ $@arg[1] == 1 ] $(
      return "ぐー";
    ) else if $[ $@arg[1] == 2 ] $(
      return "ちょき";
    ) else $(
      return "ぱー";
    );
  );
  =end
</PRE>
</TD></TR>

<TABLE class="command" width="100%">
<CAPTION>
	rmfunc<A name="rmfunc"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(rmfunc ユーザ定義関数名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	  <P>
	    ユーザが定義した関数コマンドを削除する。
	  </P>
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # my_findコマンドを削除する
  rmfunc my_find;
  =end
</PRE>
</TD></TR>
</TABLE>

</TABLE>
<TABLE class="command" width="100%">
<CAPTION>
	silent<A name="silent"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(silent)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		マルチステートメント中、silentが登場するまでの戻り値を破棄。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(echo 1 ; echo 2 ; silent ; echo 3)
  #「3」がブロックの戻り値になる
参考
  $(echo 1 ; echo 2 ; echo 3)
  #「123」がブロックの戻り値になる
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	until<A name="until"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(until 条件文 文1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文1の戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		条件文を評価し、結果が偽ならば文1を評価する。
		この動作を、条件文の評価結果が偽である間、ずっと繰り返す。
		条件文、文1に置換ブロックを用いる場合には、$()等で囲む。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  setstr A ${npw};
  setstr B ${npw};
  until $[ ${A} != ${B} ] $(
    setstr B ${npw};
  );
  # AエントリとBエントリが必ず異なるようにする
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	while<A name="while"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(while 条件文 文1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文1の戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		条件文を評価し、結果が真ならば文1を評価する。
		この動作を、条件文の評価結果が真である間、ずっと繰り返す。
		条件文、文1に置換ブロックを用いる場合には、$()等で囲む。
	</TD>
</TR>
<TR>
<TD colspan="2">
<PRE>
例
  =kis
  setstr A ${npw};
  setstr B ${npw};
  while $[ ${A} == ${B} ] $(
    setstr B ${npw};
  );
  # AエントリとBエントリが必ず異なるようにする
  =end
</PRE></TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	NULL<A name="NULL"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(NULL)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし(空文字列)
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	  空文字列を返す。<SPAN class="tt">""</SPAN>と同等。
	  過去互換性とデバッグなどの便宜のために残っている。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  if $[ ${test1} == $(NULL) ] $(
    echo "test1はカラ";
  );
  =end
  # test1が空のエントリ、もしくは評価結果が""の場合、
  # 「エントリ1はカラ」を返す
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	?<A name="randomselect"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(? 文1  文2 ...  文n)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文1から文nまでの内どれか一つの戻り値
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		文1～文nから、どれか一つをランダムに選んで評価する。
		拡張makotoの代用。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(? "右" "左")"に行く"
  # 「右に行く」または「左に行く」が返る
</PRE>
</TD></TR>
</TABLE>

<A name="dic-handle"></A>
<H4>4.2.2. コマンド-辞書操作</H4>

<TABLE class="command" width="100%">
<CAPTION>
	辞書操作コマンド共通事項<A name="dictcommon"></A>
</CAPTION>
<TR>
	<TD width="10%">&nbsp;</TD>
	<TD>
		辞書操作コマンドのうち、単語・文字列セット/追加/挿入コマンド、
		get、getcode、clearコマンドは、
		共通してエントリを配列として扱う機能がある。これらのコマンドでは、
		エントリ名を書く場所で、次のように書くことが出来る。
		<UL>
		<LI>「エントリ1」と書いた場合、エントリ1全体を指す。</LI>
		<LI>「エントリ1[0]」と書いた場合、エントリ1の1番目の単語を指す。</LI>
		<LI>「エントリ1[0..3]」と書いた場合、
			エントリ1の1番目から4番目の単語を指す。</LI>
		<LI>「エントリ1[-1]」と書いた場合、エントリ1の末尾の単語を指す。</LI>
		<LI>「エントリ1[-2..-4」と書いた場合、
			エントリ1の末尾から2番目から、末尾から4番目の単語を指す。
		</UL>
		[ ]内はエントリ配列呼び出し同様、0オリジンであることに注意。
		また、[ ]内で存在しない添え字を指定した場合、無視する。
		なお、上記機能はエントリ配列呼び出しと見た目・機能が似ているが、
		<EM>まったく無関係の機能</EM>であることに注意。<BR>
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  word : "one" , "two" , "three" , "four" , "five" , "six" , "seven"
  
  =kis
  setstr word[4] "5th element";
  # wordエントリ5番目の単語を「5th element」で置き換える
  
  setstr word2[0..5] "初期値";
  # word2エントリに6個の「初期値」という文字列をセットする
  
  clear word[1];
  # wordエントリの2番目の単語(two)を削除

  get word;
  # 「onethreefour5th elementsixseven」を返す
  
  get word[100];
  # wordエントリには6個しか単語がないので、何も返さない
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	adddict<A name="adddict"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(adddict エントリ1 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1に単語1を追加する。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # npwエントリに「田中真紀子」を追加
  adddict npw 田中真紀子;
  
  # nameエントリにnpwエントリ中の単語を追加
  adddict name ${npw}
  
  # Actエントリに単語「${normal}」を追加
  adddict Act "${normal}";
  
  # 次の行を実行すると、normalエントリの中を単語を呼び出す
  echo ${Act};
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	adddictstr<A name="adddictstr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(adddictstr エントリ1 文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1に文字列1を追加する。adddictとの違いは、
		追加したものが必ず置換ブロックではなく、文字列になる点である。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。

	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # npwエントリに「田中真紀子」を追加
  adddictstr npw 田中真紀子;
  
  # nameエントリにnpwエントリ中の単語を追加
  adddictstr name ${npw}
  
  # Actエントリに文字列「${normal}」を追加
  adddictstr Act "${normal}";
  
  # 次の行を実行すると、「${normal}」を返す。
  echo ${Act};
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	clear<A name="clear"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(clear エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1から単語を削除する。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  test1 : word1, word2, word3

  =kis
  foreach @word test1 $(echo ${@word})
  # 「word1word2word3」を返す

  clear test1;
  # test1エントリの内容を全て消去

  foreach @word test1 $(echo ${@word})
  # 何も返さない
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  cleartree<A name="cleartree"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(cleartree エントリ1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    「エントリ1.」で名前が始まるエントリの内容を全て削除する。
    例えば「エントリ1.a」、「エントリ1.b」というエントリがあったとすると、
    これらの内容が削除される。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1.name : まゆら
  ghost1.shiori : 華和梨
  ghost1.shiori.phase : 7.3.1
  ghost1.author : 夢蛍
  ghost1.shell : サンタ,着せ替え,白,夏服
  
  =kis
  cleartree ghost1;
  =end
  # 上記エントリの内容は全て削除される
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  copy<A name="copy"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(copy エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    エントリ1の内容を、すべてエントリ2にコピーする。
    エントリ2の以前の内容はそのまま残り、
    エントリ1の内容をエントリ2に追加する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1 : さくら , まゆら , 奈留 , 理夢 , ${ghost2}
  ghost2 : サンバーレイン , 毒子 , 花ちゃん
  
  =kis
  copy ghost1 ghost3;
  
  getcode ghost3;
  # 「"さくら""まゆら""奈留""理夢"${ghost2}」が返る
  
  size ghost1;
  # 5が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  copytree<A name="copytree"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(copytree エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    「エントリ1.」で名前が始まるエントリの構造を、エントリ2にコピーする。
    例えば「エントリ1.a」、「エントリ1.b」というエントリがあったとすると、
    それぞれの内容を「エントリ2.a」、「エントリ2.b」エントリにコピーする。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1.name : まゆら
  ghost1.shiori : 華和梨
  ghost1.shiori.phase : 7.3.1
  ghost1.author : 夢蛍
  ghost1.shell : サンタ,着せ替え,白,夏服
  
  =kis
  copytree ghost1 ghost2;
  =end
  # 「ghost2.」で始まるエントリの内容が、次のようになる
  # ghost2.name : まゆら
  # ghost2.shiori : 華和梨
  # ghost2.shiori.phase : 7.3.1
  # ghost2.author : 夢蛍
  # ghost2.shell : サンタ,着せ替え,白,夏服
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	find<A name="find"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
	 $(find エントリ1 単語1)<BR>
	 $(find エントリ1 単語1 インデックス)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		単語1の位置。見つからなかった場合"-1"。
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	  エントリ1内で、単語1が現れる最初の位置を返す。
	  インデックスが指定された場合、そのインデックス以降で、
	  最後に現れる位置を返す。
	  インデックスは整数でなければならない。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  地名: ここ, ${人名}の家, 三丁目, ここ, ${人名}の仕事場
  候補: ${人名}の家

  =kis
  find 地名 ここ;
  # "0"が返る。

  find 地名 ここ 1;
  # "3"が返る。

  find 地名 "${人名}"の家;
  # "1"が返る。

  find 地名 $(getcode 候補[0]);
  # "1"が返る。
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	get<A name="get"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(get エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の指定範囲の単語を全て評価した結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の指定範囲の単語を、添え字昇順で全て評価し、
		結果を結合して返す。指定範囲を省略した場合、
		エントリ1の全単語が対象となる。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  word1 : あ , い , う , え , お
  word2 : $(date %y) , $(date %M) , $(date %d)

  =kis
  get word1;
  # 「あいうえお」を返す
  get word2;
  # 「20020425」の形式で今日の日付を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	getcode<A name="getcode"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(getcode エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の指定範囲の単語を全て評価前の形式で結合した結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の指定範囲の単語を、添え字昇順で全て評価せずに参照し、
		結果を結合して返す。指定範囲を省略した場合、
		エントリ1の全単語が対象となる。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  word1 : あ , い , う , え , お
  word2 : $(date %y) , $(date %M) , $(date %d)

  =kis
  get word1;
  # 「"あ""い""う""え""お"」を返す
  get word2;
  # 「$(date %y)$(date %M)$(date %d)」を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	getrandom<A name="getrandom"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(getrandom エントリ1 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の単語のいずれか、または単語1
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の単語をランダムに1つ選択し、評価結果を返す。
		エントリ1に単語が無かった場合、単語1を返す。
		機能はentryとまったく同じである。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  getrandom "npw";
  # ${npw}と同じ
  
  getrandom "message."$(rand 3);
  # ${message.0}から${message.2}のどれかと同じ

  getrandom "System.OtherGhost" ${myname};
  # ${System.OtherGhost}と同じ
  # 結果が空の場合は、${myname}の戻り値が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	insert<A name="insert"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(insert エントリ1[インデックス1] 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の「インデックス1+1」番目の単語の直前に、単語1を挿入する。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  word : 1 , 2 , 3 , 4 , 5 , 6 , 7
  key : AAA
  
  =kis
  get word;
  # 「1234567」が返る
  
  insert word[3] "${key}";
  
  get word;
  # 「123AAA4567」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	insertstr<A name="insertstr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(insertstr エントリ1[インデックス1] 文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の「インデックス1+1」番目の単語の直前に、文字列1を挿入する。
		insertとの違いは、
		追加したものが必ず置換ブロックではなく、文字列になる点である。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  word : 1 , 2 , 3 , 4 , 5 , 6 , 7
  key : AAA
  
  =kis
  get word;
  # 「1234567」が返る
  
  insertstr word[3] "${key}";
  
  get word;
  # 「123${key}4567」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  listsub<A name="listsub"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(listsub エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    「エントリ2.」で名前が始まり、それ以上「.」が含まれないエントリ名の一覧を、エントリ1に追加する。
   エントリ2に「.」を指定すると、最上位(「.」を全く含まない)エントリ名の一覧が得られる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1.name : まゆら
  ghost1.shiori : 華和梨
  ghost1.shiori.phase : 7.3.1
  ghost1.author : 夢蛍
  ghost1.shell : サンタ,着せ替え,白,夏服
  
  =kis
  listsub 一覧 ghost1;

  getcode 一覧;
  # "ghost1.name""ghost1.shiori""ghost1.author""ghsot1.shell"が返る。
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  listtree<A name="listtree"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(listtree エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    「エントリ2.」で名前が始まるエントリ名一覧を、エントリ1に追加する。
    エントリ2に「.」を指定すると、全エントリ名一覧を取得できる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  listtree SHIORI System.Request;
  # SHIORIエントリに、本体からのリクエストヘッダ一覧を追加する
  
  listree Entries .;
  # 全エントリ名をEntriesエントリに追加。主に今は亡き対GET Status用
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  move<A name="move"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(move エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    エントリ1の内容を、すべてエントリ2に移す。
    実行後、エントリ1の内容は削除される。
    エントリ2の以前の内容はそのまま残り、
    エントリ1の内容をエントリ2に追加する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1 : さくら , まゆら , 奈留 , 理夢 , ${ghost2}
  ghost2 : サンバーレイン , 毒子 , 花ちゃん
  
  =kis
  move ghost1 ghost3;
  
  getcode ghost3;
  # 「"さくら""まゆら""奈留""理夢"${ghost2}」が返る
  
  size ghost1;
  # 0が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  movetree<A name="movetree"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(movetree エントリ1 エントリ2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    「エントリ1.」で名前が始まるエントリの構造を、エントリ2に移す。
    例えば「エントリ1.a」、「エントリ1.b」というエントリがあったとすると、
    それぞれの内容を「エントリ2.a」、「エントリ2.b」エントリにコピーする。
    その後エントリ1.a、エントリ1.b等を削除する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghost1.name : まゆら
  ghost1.shiori : 華和梨
  ghost1.shiori.phase : 7.3.1
  ghost1.author : 夢蛍
  ghost1.shell : サンタ,着せ替え,白,夏服
  
  =kis
  movetree ghost1 ghost2;
  =end
  # 「ghost2.」で始まるエントリの内容が、次のようになる
  # ghost2.name : まゆら
  # ghost2.shiori : 華和梨
  # ghost2.shiori.phase : 7.3.1
  # ghost2.author : 夢蛍
  # ghost2.shell : サンタ,着せ替え,白,夏服
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	pop<A name="pop"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(pop エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の末尾の単語
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の末尾にある単語を削除し、それを返す。
		エントリ1に単語が無ければ、空文字列を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  PASOPIA : パソピア7
  oldmachine : PC9801,X68k,MSX2,PC8801,X1,PC8001,${PASOPIA}
  
  =kis
  foreach @pc oldmachine $(echo " "${@pc});
  # 「 PC9801 X68k MSX2 PC8801 X1 PC8001 パソピア7」を返す
  
  pop oldmachine;
  # 「パソピア7」を返す
  
  foreach @pc oldmachine $(echo " "${@pc});
  # 「 PC9801 X68k MSX2 PC8801 X1 PC8001」を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	popcode<A name="popcode"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(popcode エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の末尾の単語の評価前の形式
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の末尾にある単語を削除し、評価前の形式で返す。
		エントリ1に単語が無ければ、空文字列を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  PASOPIA : パソピア7
  oldmachine : PC9801,X68k,MSX2,PC8801,X1,PC8001,${PASOPIA}
  
  =kis
  foreach @pc oldmachine $(echo " "${@pc});
  # 「 PC9801 X68k MSX2 PC8801 X1 PC8001 パソピア7」を返す
  
  popcode oldmachine;
  # 「${PASOPIA}」を返す
  
  foreach @pc oldmachine $(echo " "${@pc});
  # 「 PC9801 X68k MSX2 PC8801 X1 PC8001」を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	push<A name="push"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(push エントリ1 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の末尾に単語1を追加する。adddictと同義。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # npwエントリに「田中真紀子」を追加
  push npw 田中真紀子;
  
  # nameエントリにnpwエントリ中の単語を追加
  push name ${npw}
  
  # Actエントリに単語「${normal}」を追加
  push Act "${normal}";
  
  # 次の行を実行すると、normalエントリの中を単語を呼び出す
  echo ${Act};
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	pushstr<A name="pushstr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(pushstr エントリ1 文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の末尾に文字列1を追加する。adddictstrと同義。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # npwエントリに「田中真紀子」を追加
  pushstr npw 田中真紀子;
  
  # nameエントリにnpwエントリ中の単語を追加
  pushstr name ${npw}
  
  # Actエントリに文字列「${normal}」を追加
  pushstr Act "${normal}";
  
  # 次の行を実行すると、「${normal}」を返す。
  echo ${Act};
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	rfind<A name="rfind"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
	 $(rfind エントリ1 単語1)<BR>
	 $(rfind エントリ1 単語1 インデックス)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		単語1の位置。見つからなかった場合"-1"。
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	  エントリ1内で、単語1が現れる最後の位置を返す。
	  インデックスが指定された場合、そのインデックス以前で、
	  最後に現れる位置を返す。
	  インデックスは整数でなければならない。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  地名: ここ, ${人名}の家, 三丁目, ここ, ${人名}の仕事場
  候補: ${人名}の家

  =kis
  rfind 地名 ここ;
  # "3"が返る。

  rind 地名 ここ 2;
  # "0"が返る。

  rfind 地名 "${人名}"の家;
  # "1"が返る。

  rfind 地名 $(getcode 候補[0]);
  # "1"が返る。
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	set<A name="set"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(set エントリ1 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の内容を削除してから、単語1を登録する。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  dummy : 1
  angry : 怒ってるゾ！
  
  =kis
  set mode 1;
  # modeエントリの内容は「1」だけになる
  
  set mody ${dummy};
  # modeエントリの内容は${dummy}＝「1」になる
  
  set emotion "${angry}";
  # emotionエントリの内容は単語「${angry}」になる
  
  echo ${emotion};
  # 「怒ってるゾ！」を返す
  
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	setstr<A name="setstr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(setstr エントリ1 文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の内容を削除してから、文字列1を登録する。
		setとの違いは、
		追加したものが必ず置換ブロックではなく、文字列になる点である。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  dummy : 1
  angry : 怒ってるゾ！
  
  =kis
  setstr mode 1;
  # modeエントリの内容は「1」だけになる
  
  setstr mody ${dummy};
  # modeエントリの内容は${dummy}＝「1」になる
  
  setstr emotion "${angry}";
  # emotionエントリの内容は文字列「${angry}」になる
  
  echo ${emotion};
  # 「${angry}」を返す
  
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	shift<A name="shift"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(shift エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の先頭にある単語
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の先頭にある単語を一つ削除し、それを返す。
		エントリ1に単語が無ければ、空文字列を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  counter : 1, 2, 3, 4, 5
  sentence : \hこの文が呼ばれるのは$(shift counter)回目だね。\e
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	shiftcode<A name="shiftcode"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(shiftcode エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		エントリ1の先頭にある単語の評価前の形式
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の先頭にある単語を一つ削除し、評価前の形式で返す。
		エントリ1に単語が無ければ、空文字列を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  counter : 1, 2, 3, 4, 5
  sentence : \hこの文が呼ばれるのは$(shiftcode counter)回目だね。\e
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	size<A name="size"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(size エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		単語数
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1中の単語数を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  理夢 : 理夢
  ninni.angels,famous.ghosts : 奈留, せりこ, まゆら, ${理夢}
  dark.sisters,famous.ghosts : 毒子, 花ちゃん, サンバーレイン, ${理夢}
  
  =kis
  size dark.sisters;
  # 4が返る
  
  size famous.ghosts;
  # 8が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	unshift<A name="unshift"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(unshift エントリ1 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の先頭に単語1を挿入する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghosts : まゆら,理夢,毒子,白子,美耳,陽子
  任意 : さくら
  
  =kis
  get ghosts;
  # 「まゆら理夢毒子白子美耳陽子」を返す
  
  unshift ghosts "${任意}";
  
  get ghosts;
  # 「さくらまゆら理夢毒子白子美耳陽子」を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	unshiftstr<A name="unshiftstr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(unshiftstr エントリ1 文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1の先頭に文字列1を挿入する。
		unshiftとの違いは、
		追加したものが必ず置換ブロックではなく、文字列になる点である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  ghosts : まゆら,理夢,毒子,白子,美耳,陽子
  任意 : さくら
  
  =kis
  get ghosts;
  # 「まゆら理夢毒子白子美耳陽子」を返す
  
  unshift ghosts "${任意}";
  
  get ghosts;
  # 「${任意}まゆら理夢毒子白子美耳陽子」を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	writeprotect<A name="writeprotect"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(writeprotect エントリ1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	 エントリ1を(起動中)書き込み不可にする。
	 従来resource.homeurlなどはシステム側でプロテクトしていたが、
	 Phase 8では重要情報がどこに書かれるか分からないため、
	 ユーザやミドルウェアが自分でプロテクトをかけられるようにした。
	 プロテクトを外すコマンドは存在しない。
	 プロテクトされたエントリに書き込もうとした場合、Errorレベルのログが出力される。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  username : ご主人様

  =kis
  writeprotect username;
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="file-io"></A>
<H4>4.2.3. コマンド-ファイル操作</H4>

<TABLE class="command" width="100%">
<CAPTION>
	cncpath<A name="cncpath"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(cncpath パス名)
		$(cncpath パス名 ファイル名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		正規化したパス名
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		パス区切り記号に'/'と'\'が混在したパス名を、
		実装したファイルシステムで適切なパス区切り記号に変換して返す。
		ファイル名も指定した場合、パスと適切な形で結合して、
		同じように適切なパス区切り記号で返す。
		パスとして解釈できない場合、何も返さない。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # ここではMS Windows上のオリジナル華和梨を想定している
  
  # "..\..\unix"が返る
  cncpath ../../unix;
  
  # "C:\WINDOWS\SYSTEM"が返る
  cncpath C:/WINDOWS\SYSTEM
  
  # "..\..\UNIX\LS.EXE"が返る
  cncpath ../../UNIX/ LS.EXE
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	dirname<A name="dirname"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(dirname パス名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		正規化したディレクトリ名
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられたパス名をcncpathで正規化し、
		ディレクトリ名部分を抽出して返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # ここではMS Windows上のオリジナル華和梨を想定している
  
  # "C:\Program Files\Microsoft Office\Office"が返る
  dirname "C:/Program Files/Microsoft Office/Office/POWERPNT.EXE"
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	filename<A name="filename"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(filename パス名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		ファイル名
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられたパス名をcncpathで正規化し、
		ファイル名部分を抽出して返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # ここではMS Windows上のオリジナル華和梨を想定している
  
  # "POWERPNT.EXE"が返る
  filename "C:/Program Files/Microsoft Office/Office/POWERPNT.EXE"
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	isdir<A name="isdir"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(isdir パス名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		パスがディレクトリならば真、そうでなければ偽
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられたパス名がディレクトリかどうか判定する。
		パスがディレクトリならば真、そうでなければ偽を返す。
		パスのファイルが存在しない場合の動作は不定である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # MATERIAのghost\masterフォルダで実行した場合を想定
  
  isdir $(cncpath profile);
  # 1が返る
  isdir shiori.dll;
  # ""が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	isexist<A name="isexist"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(isexist パス名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		パスが存在すれば真、そうでなければ偽
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられたパス名が存在するかどうか判定する。
		パスが存在すれば真、そうでなければ偽を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # MATERIAのghost\masterフォルダで実行した場合を想定
  
  isexist $(cncpath profile);
  # 1が返る
  isexist shiori.dll;
  # 1が返る
  isexist $(cncpath ..\..\..\..\embryo.exe);
  # ""が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	isfile<A name="isfile"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(isfile パス名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		パスが通常ファイルならば真、そうでなければ偽
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられたパス名が通常ファイルかどうか判定する。
		パスが通常ファイルならば真、そうでなければ偽を返す。
		パスのファイルが存在しない場合の動作は不定である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # MATERIAのghost\masterフォルダで実行した場合を想定
  
  isfile $(cncpath profile);
  # ""が返る
  isfile shiori.dll;
  # 1が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	load<A name="load"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(load ファイル名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		華和梨辞書形式ファイルを読み込む。暗号化辞書も可。
		ファイル名の先頭が「/」「\」またはドライブ名から始まる場合には
		絶対パスとみなし、それ以外の場合にはゴーストのディレクトリからの
		相対パスとみなす。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  load dict-flag.txt;
  # dict-flag.txtを読み込む
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	readdir<A name="readdir"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(readdir エントリ1 ディレクトリ)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		指定ディレクトリに含まれるファイル・ディレクトリ名を
		エントリ1に保存する。エントリ1の以前の内容は消去される。<BR>
		ディレクトリ名は相対パスも可。カレントディレクトリの'.'、
		親ディレクトリの'..'は予め削除される。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  readdir shell "..\..\shell";
  # 自ゴーストで使用できるシェル一覧をshellに保存
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	save<A name="save"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(save ファイル名 エントリ名1 ... )
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		ファイルにエントリ内容を華和梨辞書形式でセーブする。
		指定ファイルの以前の内容は消去し、
		指定エントリ群の内容でファイルを上書きする。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  save dict-flag.txt flag1 flag2 flag3;
  # flag1、flag2、flag3エントリをdict-flag.txtに保存
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	savecrypt<A name="savecrypt"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(savecrypt ファイル名 エントリ名1 ... )
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		ファイルにエントリ内容を暗号化華和梨辞書形式でセーブする。
		指定ファイルの以前の内容は消去し、
		指定エントリ群の内容でファイルを上書きする。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  savecrypt dict-flag.txt flag1 flag2 flag3;
  # flag1、flag2、flag3エントリをdict-flag.txtに暗号化して保存
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	textappend<A name="textappend"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(textappend ファイル名 エントリ1 [エントリ2..])
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1、エントリ2…の全ての内容を、テキストファイル1に追記する。
		セキュリティの観点から、書き出すファイル名は相対パスのみである。
		エントリの内容は、添え字順に評価してその結果を書き出す。
		ファイルに書き出す際、添え字ごとに最後に改行する。
		textsaveとの違いは、テキストファイル1の以前の内容が残る点である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  textappend highscore.dat 新タイトル保持者名;
  # highscore.datに、「新タイトル保持者名」エントリの内容を追記
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	textload<A name="textload"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(textload エントリ1 テキストファイル1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		テキストファイル1の内容を読み込む。<BR>
		ファイルの1行目はエントリ1の一つ目の単語、
		2行目はエントリ1の二つ目の単語となる。
		行末の改行コードは、削除してからエントリに格納する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  textload poem mypoem.txt;
  # poemエントリにファイル'mypoem.txt'を読み込む
  
  echo \0$(set @i 0 ; loop $(size poem) $(get poem[${@i}] ; inc @i))\e;
  # ファイルmypoem.txtの内容を読み込み、さくら側バルーンで内容を表示する
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	textsave<A name="textsave"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD>
		$(textsave ファイル名 エントリ1 [エントリ2..])
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1、エントリ2…の全ての内容を、テキストファイル1に書き出す。
		セキュリティの観点から、書き出すファイル名は相対パスのみである。
		エントリの内容は、添え字順に評価してその結果を書き出す。
		ファイルに書き出す際、添え字ごとに最後に改行する。
		textappendとの違いは、テキストファイル1の以前の内容が残らない点である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  textsave highscore.dat タイトル保持者名一覧;
  # highscore.datに、「タイトル保持者名一覧」エントリの内容を保存
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="counter"></A>
<H4>4.2.4. コマンド-カウンタ</H4>

<TABLE class="command" width="100%">
<CAPTION>
	dec<A name="dec"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(dec エントリ1 減分 下限)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1を減分だけ減算する。減分と下限は省略可能。
		減分を省略した場合、1と見なす。
		減算した結果が下限より小さくなった場合、エントリ1の内容は下限となる。
		下限を省略するといつまでも減算できる。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  dec N;
  # Nを1だけ減らす
  
  dec N 5;
  # Nを5だけ減らす
  
  dec N 10 0;
  # Nを10だけ減らし、結果が0より小さければNは0とする
  
  dec N[0];
  # N[0]を1だけ減らす
  
  dec N[0..3] 2 0;
  # N[0]からN[3]までをそれぞれ2だけ減らし、結果が0より小さければ0とする
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	inc<A name="inc"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(inc エントリ1 増分 上限)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリ1を増分だけ加算する。増分と上限は省略可能。
		増分を省略した場合、1と見なす。
		加算した結果が上限より大きくなった場合、エントリ1の内容は上限となる。
		上限を省略するといつまでも加算できる。<BR>
		エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  inc N;
  # Nを1だけ増やす
  
  inc N 5;
  # Nを5だけ増やす
  
  inc N 10 100;
  # Nを10だけ増やし、結果が100より大きければNは100とする
  
  inc N[2] 4;
  # N[2]を4だけ増やす
  
  inc N[1..-1] 2 100;
  # N[0]以外のNをそれぞれ2だけ増やし、結果が100より大きければ100とする
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="string"></A>
<H4>4.2.5. 文字列操作</H4>

<TABLE class="command" width="100%">
<CAPTION>
  char_at<A name="char_at"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(char_at 文字列1 インデックス)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    文字列1の「インデックス+1」文字目の文字
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列の指定した場所の1文字を返す。
    マルチバイト文字も1文字と数える。
    インデックスは0オリジンであることに注意。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  char_at 世界よ、こんにちは。 2;
  # 「よ」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	chr<A name="chr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(chr 文字コード)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		指定した文字コードの一文字
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		指定した文字コードの一文字を返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  chr 1;
  # いわゆる「バイト値1」が返る
  
  chr 2;
  # いわゆる「バイト値2」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  compare<A name="compare"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(compare 文字列1 文字列2)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    -1、0、1のいずれか
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    文字列同士を辞書順序で比較する。
    文字列1が文字列2より辞書順で後ならば1、
    文字列1が文字列2より辞書順で前ならば-1、
    文字列1と文字列2が等しければ0を返す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  dict : a , aa , b , c , xa , xy , z
  word : hello
  
  =kis
  setstr @count 0;
  loop $(size dict) $(
    if $[ $(compare $dict[${@count}] ${word}) &lt; 1 ] $(
      inc @count;
    ) else $(
      break;
    );
  );
  insertstr dict[${@count}] ${word};
  
  # compareを使った大小比較の例
  # 辞書順にソートしたエントリに対し、添え字0から${word}と比較し、
  # ${word}より大きな単語の直前に${word}を挿入している
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  gsub<A name="gsub"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(gsub 文字列1 パターン 置換文字列)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    置換後の文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に指定パターンがあった場合、置換文字列で置き換える。
    subとの違いは、指定文字列中に指定パターンが複数あった場合、
    全て置換する点である。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  gsub hogehogehoge ge ro;
  # 「horohorohoro」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  join<A name="join"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(join エントリ1 区切り文字)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    結合後の文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    エントリ1の内容を、区切り文字を間に挟んで順に結合して返す。
    結合の際、エントリ1の内容は順に評価される。<BR>
    区切り文字は省略可能で、省略した場合はヌル文字「""」をした場合と同じ。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  path : WINDOWS, SYSTEM32, drivers, etc
  =kis
  join path "\\";
  # 「WINDOWS\SYSTEM32\drivers\etc」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  length<A name="length"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(length 文字列1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    文字列1の長さ
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列の長さを返す。
    マルチバイト文字1字も長さ1である。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  length とても長くてすぐには何文字か分からない1byte文字も交えた例;
  # 31が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  match<A name="match"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(match 文字列1 パターン インデックス)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    パターンの文字列1の中における先頭位置
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に指定パターンがあった場合、その先頭の位置を返す。
    インデックスは省略可能で、指定した場合、
    指定文字列の「インデックス+1」文字目から検索を始める。
    省略した場合、指定文字列の先頭から検索を始める。
    戻り値は0オリジンで、パターンが存在しなかった場合、
    -1を返す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  match 芝村をやっている 村を;
  # 1が返る
  
  match あーりーあーもー殺ーるーのー あー 2;
  # 4が返る
  
  match 我は、我である。 ジャム;
  # -1が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  match_at<A name="match_at"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(match_at 文字列1 パターン インデックス)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    パターンがあれば1、なければ""
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
   文字列中のインデックス番目(0オリジン)にパターンが存在すれば1。
   存在しなければ""を返す。
   指定省略時のインデックスは0.
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  match_at 芝村をやっている 村を;
  # ""が返る
  
  match_at 芝村をやっている 村を 1;
  # 1が返る
  
  match_at あーりーあーもー殺ーるーのー あー 4;
  # 1が返る
  
  match_at 我は、我である。 ジャム;
  # ""が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  reverse<A name="reverse"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(reverse 文字列1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    前後が逆になった文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    文字列の前後を入れ替える。
    バイト単位ではなく、文字単位で入れ替えることに注意。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  reverse 上から読んでも山本山
  # 「山本山もでん読らか上」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  rmatch<A name="rmatch"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(rmatch 文字列1 パターン インデックス)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    パターンの文字列1の中における先頭位置
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に指定パターンがあった場合、その先頭の位置を返す。
    インデックスは省略可能で、指定した場合、
    指定文字列の「インデックス+1」文字目から、前方に向けて検索を始める。
    省略した場合、指定文字列の最後尾から前方に向けて検索を始める。
    戻り値は0オリジンで、パターンが存在しなかった場合、
    -1を返す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  rmatch 芝村をやっている 村を;
  # 1が返る
  
  rmatch あーりーあーもー殺ーるーのー あー 2;
  # 0が返る
  
  rmatch 我は、我である。 ジャム;
  # -1が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  rsub<A name="rsub"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(rsub 文字列1 パターン 置換文字列)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    置換後の文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に指定パターンがあった場合、置換文字列で置き換える。
    gsubとの違いは、指定文字列中に指定パターンが複数あった場合、
    最後尾の１つだけ置換する点である。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  rsub hogehogehoge ge ro;
  # 「hogehogehoro」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	split<A name="split"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(split エントリ1 文字列1 区切り文字列1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		文字列1を区切り文字列1で分割し、エントリ1に格納する。
		エントリ1の以前の内容はそのまま残り、
		新たに格納される文は、エントリ1にpushされる。<BR>
		区切り文字1は省略可能で、
		省略した場合は文字列1を文字ごとに分割する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  split string "AA:BB:CC" ":";
  # AA、BB、CCに分割
  
  split Header ${System.GhostEx} $(chr 1);
  # GhostExヘッダをバイト値1で分割
  
  split Msg "籠の中の鳥" "の";
  # 籠、中、鳥に分割
  
  split test "1ch2ch3ch" "ch";
  # 1、2、3に分割
  
  split char "世界よ、こんにちは！";
  # "世界よ、こんにちは！"を文字ごとに分割
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  sub<A name="sub"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(sub 文字列1 パターン 置換文字列)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    置換後の文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に指定パターンがあった場合、置換文字列で置き換える。
    gsubとの違いは、指定文字列中に指定パターンが複数あった場合、
    先頭の１つだけ置換する点である。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  sub hogehogehoge ge ro;
  # 「horohogehoge」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  substr<A name="substr"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(substr 文字列1 開始位置 長さ)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    部分文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    文字列1の部分文字列を返す。文字列1の「開始位置+1」文字目から、
    「長さ」文字分を返す。位置は0オリジンである。
    長さは省略でき、省略した場合、
    開始位置から末尾までを返す。
    位置が負の数の場合、末尾から数えた位置になる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  substr ABCDEFG 3 2;
  # 「DE」を返す
  
  substr ABCDEFG 3;
  # 「DEFG」を返す
  =end
</PRE>
</TD></TR>

</TABLE>
<TABLE class="command" width="100%">
<CAPTION>
	tolower<A name="tolower"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(tolower 文字列1 ...)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文字列中のアルファベット大文字を小文字に置換した結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		文字列中のアルファベット大文字を小文字に置換する。
		半角文字のみに作用する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  tolower ABC def;
  # 「abc def」が返る
  
  tolower ＸＹＺ XYZ;
  # 「ＸＹＺ xyz」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	toupper<A name="toupper"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(toupper 文字列1 ...)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		文字列中のアルファベット小文字を大文字に置換した結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		文字列中のアルファベット小文字を大文字に置換する。
		半角文字のみに作用する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  toupper ABC def;
  # 「ABC DEF」が返る
  
  toupper ｘｙｚ xyz;
  # 「ｘｙｚ XYZ」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  tr<A name="tr"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(tr 文字列1 置換対象文字 変換文字)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    置換後の文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中に置換対象文字のいずれかがあった場合、
    対応する変換文字に置き換える。
    変換文字に対応する部分がない場合、""に置き換える。
    perlのtr//dと同じ動作をする。
 </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  tr AbＣｄあいう ABCDＡＢＣＤａｂｃｄ abcdwxyz1234;
  # 「aby4あいう」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="saori"></A>
<H4>4.2.6. コマンド-SAORI</H4>

<TABLE class="command" width="100%">
<CAPTION>
  saoriregist<A name="saoriregist"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(saoriregist DLLファイル エイリアス [ オプション ] )
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    <P>
      SAORIモジュールの登録。
      DLLファイルには、相対パスまたは絶対パスでDLLを指定する。
      エイリアスは、callsaoriコマンドでSAORIモジュールを呼ぶ際のキーワードを指定する。
    </P><P>
      オプションには、SAORIモジュールをロードするタイミングを指定する。
      SAORIの中にはロードに時間のかかるものや、
      呼ばれない可能性があることも考えられるため、
      このような調整が可能となっている。
      タイミングには<SPAN class="tt">"preload", "loadoncall", "noresident"</SPAN>
      の3種類があり、
      それぞれ、「saoriregist時にロード」「最初にcallsaori(x)された時にロード」
      「callsaori時にロードし、終わったら即アンロード」を意味する。
      デフォルトはloadoncallである。
    </P>
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # saori_cpuid.dllをcpuidとして登録。今すぐロード。
  saoriregist modules\saori_cpuid.dll cpuid preload
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  saorierase<A name="saorierase"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(saorierase エイリアス)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    登録済みのSAORIを登録から抹消する。
    ロードされていたら併せてアンロードされる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # cpuidをアンロード
  saorierase cpuid;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  saorilist<A name="saorilist"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(saorilist エントリ1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    登録済みのSAORIのエイリアスを、すべてエントリ1に格納する。
    オプションの種類によらず、登録しているエイリアスを全て返すことに注意。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # System.SaoriListエントリに登録済SAORIエイリアスの一覧を格納
  saorilist System.SaoriList;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  callsaori<A name="callsaori"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    callsaori エイリアス [ 引数 引数 ... ]
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    SAORIの戻り値(Result)
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    戻り値が一つのSAORIを呼び出す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  sentence : \0\s[0]ここのOSは$(callsaori cpuid os.name)ね。\e
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  callsaorix<A name="callsaorix"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    callsaorix エイリアス 戻り値格納エントリ [ 引数 引数 ... ]
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    SAORI呼び出し結果(Result)
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    複数の戻り値を持つSAORIを呼び出し、結果を得る。
    SAORIの戻り値はValue[数値]ヘッダに格納されているが、
    これを、「<SPAN class="tt">指定エントリ.Value[数値]</SPAN>」
    エントリに格納する。
    また、「<SPAN class="tt">指定エントリ.size</SPAN>」
    に、得られた戻り値(Value)の数を返す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  # tmizu氏作のwmove.dllを使い、キャラクタの立ち位置を取得する
  =kis
  fuction getposition $(
    # 引数1 : 0=Sakura、1=Kero
    # 引数2 : 戻り値返却用エントリ名
    if $[ $@arg[1] == 0 ] $(
      setstr @characterHWnd $System.HWnd.shell[0];
    ) else if $[ $@arg[1] == 1 ] $(
      setstr @characterHWnd $System.HWnd.shell[1];
    ) else $(
      return "";
    );

    callsaorix wmove $@arg[2] GET_POSITION ${@characterHWnd};
  );
  =end
</PRE>
</TD></TR>
</TABLE>

<!--
<A name="calc"></A>
<H4>4.2.5. コマンド-評価・比較</H4>

<TABLE class="command" width="100%">
<CAPTION>
	expr<A name="expr"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(expr EXPRESSION)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		EXPRESSIONの値。真偽値は"1"(真)か""(偽)で返る。
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		EXPRESSIONで与えられた式を評価し、その値を返す。
		<A href="http://www.linux.or.jp/JM/html/gnumaniak/man1/expr.1.html">
		GNU expr</A>を規範とした機能、構文を持つ。
		以下に留意のこと。
		<UL>
			<LI>一つ一つの記号は空白で区切る。</LI>
			<LI>exprは数値と文字列の双方を扱う。ただし、
			    数値として認識されるのはいわゆる「半角」の10進整数のみ。</LI>
		</UL>
		EXPRESSIONの種類は以下の通り。<BR>
		<DL>
		<DT>ARG1 | ARG2</DT>
			<DD>ARG1。ただし、ARG1が偽ならARG2。</DD>
		<DT>ARG1 & ARG2</DT>
			<DD>ARG1。ただし、ARG1とARG2どちらかが真でないなら、""。</DD>
		<DT>ARG1 &lt; ARG2</DT>
			<DD>ARG1がARG2より小さければ真("1")。そうでないなら偽("")。
			以下、比較演算は全て文字列にも適用可。</DD>
		<DT>ARG1 &lt;= ARG2</DT>
			<DD>ARG1がARG2と等しいか、より小さければ真。そうでなければ偽。</DD>
		<DT>ARG1 = ARG2</DT>
			<DD>ARG1とARG2が等しければ真。"=="にも対応。</DD>
		<DT>ARG1 != ARG2</DT>
			<DD>ARG1とARG2が等しくなければ真。</DD>
		<DT>ARG1 &gt;= ARG2</DT>
			<DD>ARG1がARG2と等しいか、より大きければ真。そうでなければ偽。</DD>
		<DT>ARG1 &gt; ARG2</DT>
			<DD>ARG1がARG2より大きければ真。そうでなければ偽。</DD>
		<DT>ARG1 + ARG2</DT>
			<DD>加算。どちらかあるいは両方が数値でなければ""。</DD>
		<DT>ARG1 - ARG2</DT>
			<DD>減算。どちらかあるいは両方が数値でなければ""。</DD>
		<DT>ARG1 * ARG2</DT>
			<DD>乗算。どちらかあるいは両方が数値でなければ""。</DD>
		<DT>ARG1 / ARG2</DT>
			<DD>除算。どちらかあるいは両方が数値でなければ""。</DD>
		<DT>ARG1 % ARG2</DT>
			<DD>剰余。ARG1をARG2で割った余り。
			どちらかあるいは両方が数値でなければ""。</DD>
		<DT>substr STRING POS LENGTH</DT>
			<DD>部分文字列を得る。
			STRING中のPOS番目の文字からLENGTH長だけ切り出す。
			POSは1から数えるので注意。いわゆる「全角文字」も1文字ずつ数える。</DD>
		<DT>index STRING CHARS</DT>
			<DD>STRING中でCHARSに含まれるどれかの文字が最初に現れる場所を返す。
			位置は1から数える。</DD>
		<DT>length STRING</DT>
			<DD>STRINGの長さ。</DD>
		<DT>quote  TOKEN</DT>
			<DD>TOKENを一まとまりの文字列とみなす。
			TOKENが"index"や"length"であってもそれをキーワードとしないようにする。</DD>
		<DT>( EXPRESSION )</DT>
			<DD>EXPRESSIONの評価結果。これを使って入れ子の表現が可能になる。
			<SPAN class="tt">$(～)</SPAN>
			のインラインスクリプトそのものを入れ子にするわけではないことに注意。
			<SPAN class="tt">$(expr 遅いねぇ & ( ( date %H ")" > 22 ")")</SPAN>
			などということは不可能。
			ただし、<SPAN class="tt">$(expr 遅いねぇ & ( $(date %H) > 22 ")")</SPAN>
			は可能。
			また、<SPAN class="tt">)</SPAN>
			をクォートしないと<SPAN class="tt">$(</SPAN>
			の対応カッコだと思われるので注意。
			</DD>
		<DT>find STRING SUBSTRING</DT>
			<DD>STRING中にSUBSTRINGがあればSUBSTRINGを返す。無ければ""。
			本来のexprには存在しないが、matchが無いので代替品として導入した。
			</DD>
		<DT>findpos STRING SUBSTRING</DT>
			<DD>STRING中にSUBSTRINGがあれば、その先頭の位置を返す。なければ""。
			同じく本来のexprには存在しないが、頻繁に使うので導入した。
			</DD>
		<DT>STRING : REGEXP</DT>
		<DT>match STRING REGEXP</DT>
			<DD>未実装。</DD>
		</DL>
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例：
$(expr ${npw.special} | ${npw})
    # npw.specialに内容があれば、それ。無ければnpwの置換結果が返る。

$(expr ${system.Sender} & ${system.Sentence})
    # system.Sentenceとsystem.Sender双方に内容があれば、
    # system.Senderが返る。

$(expr substr １2３4５6７ 1 3)
    # 出力 : １2３

\u$(expr substr ${dms} 1 6)\w8\w8…\w8\w8…\w8\w8\w8\w8
\h\s[7]どうして途中で止めるんだよっ！\w8\e

$(expr index 華和梨の代わり わ)
    # 出力 : 6

$(expr 20 * ( 3 + 2 ")")
    # 出力 : 100

$(expr ${system.Sender} & ( ${system.Sender} != まゆら ")")
    # system.Senderが空  →  (出力無し)
    # system.Senderが"まゆら" → (出力無し)
    # system.Senderが"まゆら"以外 → system.Senderの値

$(expr find 華和梨の代わり わ)
    # 出力 : わ
$(expr findpos 華和梨の代わり わ)
    # 出力 : 6
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	test<A name="test"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(test 条件式)<BR>$([ 条件式 ])
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		条件式が真なら"true"、偽なら"false"
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		条件式の真偽を返す。比較演算子は以下が使える。
		<UL>
		<TABLE border="0">
		<TR><TD></TD><TD></TD><TD>A : Aが真ならば真</TD></TR>
		<TR><TD></TD><TD align="center">!</TD><TD>A  : Aが偽ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">==</TD><TD>B : AとBが同じ文字列ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">=</TD><TD>B : AとBが同じ文字列ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">!=</TD><TD>B : AとBが同じ文字列でなければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">&lt;</TD><TD>B : AがBより辞書順で前にあれば真</TD></TR>
		<TR><TD>A</TD><TD align="center">&gt;</TD><TD>B : AがBより辞書順で後にあれば真</TD></TR>
		<TR><TD>A</TD><TD align="center">&lt;=</TD><TD>B : AがBより辞書順で後でなければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">&gt;=</TD><TD>B : AがBより辞書順で前になければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">-eq</TD><TD>B : AがBと等しければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">-ne</TD><TD>B : AがBと等しくなければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">-lt</TD><TD>B : AがBより小さければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">-gt</TD><TD>B : AがBより大きければ真</TD></TR>
		<TR><TD>A</TD><TD align="center">-le</TD><TD>B : AがB以下ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">-ge</TD><TD>B : AがB以上ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">&&</TD><TD>B : AとBが共に真ならば真</TD></TR>
		<TR><TD>A</TD><TD align="center">||</TD><TD>B : AもしくはBが真ならば真</TD></TR>
		</TABLE>
		</UL>
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  XBOX : toy
  PS2 : computer
  Workstation : computer
  ZAURUS : 40000
  visor : 25000
  $(test ${XBOX} == "toy")       # 「true」が返る
  $(test ${PS2} != "computer")   # 「false」が返る
  $(test ${ZAURUS} -lt ${visor}) # 「false」が返る
  $(if $([ ${PS2} == ${Workstation} ]) "\hPS2欲しい！\e" "\hPS2いらない。\e")
  # 「PS2欲しい！」と表示する
</PRE>
</TD></TR>
</TABLE>
-->

<A name="communicate"></A>
<H4>4.2.7. コマンド-コミュニケート機能</H4>

<TABLE class="command" width="100%">
<CAPTION>
  communicate<A name="communicate"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(communicate エントリ1 単語1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    エントリ1の示すエントリの単語、もしくは単語1
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    エントリ1の単語を全て評価し、戻り値があった単語をランダムに1個選び、
    これをエントリ名と見なしてエントリ呼び出しの結果を返す。
    戻り値のあった単語が1つも無い場合、単語1を返す。
    単語1は省略可能。<BR>
    エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  毒子.keyword1 : うむ , ふはははは , 変態
  毒子.answer1  : \t\0\s[7]胸のことは言うなっ！\e
  毒子.answer1  : \t\0\s[1]…。\e
  
  花ちゃん.keyword1 : どないしたんや , 同じ中学生なのに
  花ちゃん.answer1  : \t\0\s[8]あ‥‥\w8あまりじろじろ見んといてな。\e
  花ちゃん.answer1  : \t\0\s[1]花ちゃんかて…。\e
  
  match_keys : $(
    if $[ ${System.Request.Reference0} == "毒子" ] $(
      if $(xargs 毒子.keyword1 matchall ${System.Request.Reference1})
        毒子.answer1
    )
  )
  
  match_keys : $(
    if $[ ${System.Request.Reference0} == "花ちゃん" ] $(
      if $(xargs 花ちゃん.keyword1 matchall ${System.Request.Reference1})
        花ちゃん.answer1
    )
  )
  
  event.OnCommunicate : $(communicate match_keys ${communicate.else})
  
  # コミュニケートコマンド群を用いたコミュニケートの実装例
  # OnCommunicateイベントでcommunicateコマンドを使い、イベント反応を
  # 記述したmatch_keysエントリを全て評価、戻り値のうち一つを選ぶ
  # そして、戻り値をエントリ名と見なしてエントリ呼び出しを行い、それを返す
  # 何も無い場合、communicate.elseエントリの単語を返す
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  matchall<A name="matchall"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(matchall 文字列1 キーワード1 ...)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    真または偽
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    キーワードが全て文字列1にあった場合、真を返す。
    キーワードは1個以上ならば、いくつでも列挙できる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  毒子.keyword1 : あらあら , 最近 , 中学生 , 乳
  
  =kis
  matchall ${System.Request.Reference1} こんにちは;
  # Reference1に「こんにちは」が含まれる場合、真を返す
  
  matchall ${System.Request.Reference1} うにゅう おいしい ？;
  # Reference1に「うにゅう」「おいしい」「？」が含まれる場合、真を返す
  # 例えば「うにゅうっておいしいの？」と言う文章がきた場合、真を返す
  
  xargs 毒子.keyword1 matchall ${System.Request.Reference1};
  # xargsとの合わせ技
  # xargsで毒子.keyword1エントリの単語を「matchall..」以降に列挙
  # 結果として、毒子.keyword1エントリの単語がすべてReference1に含まれる
  # 場合、真を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="output"></A>
<H4>4.2.8. コマンド-出力</H4>

<TABLE class="command" width="100%">
<CAPTION>
	echo<A name="echo"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(echo 単語1 ...)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		全引数を空白文字で接続したもの
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられた全引数を、空白文字で区切って返す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  echo 1 2 3 4 5;
  # 「1 2 3 4 5」が返る
  
  setstr test1 "TEST";
  echo ${test1};
  # 「TEST」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  encode_entryname<A name="encode_entryname"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(encode_entryname 文字列1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    エントリ名に使用できる文字に変換した文字列
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    指定文字列中のエントリ名に使用できない文字を変換し、
    エントリ名に使用できる文字列を返す。
    使用できない文字は、"_"に変換する。
    エントリ名に使用できない文字については、
    KIS Programming Reference の「3.華和梨文法」を参照のこと。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  encode_entryname "「#」や「,」や「 」はエントリ名に使えません";
  # "「_」や「_」や「_」はエントリ名に使えません"が返る。
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	escape<A name="escape"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(escape 単語1 ...)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		全引数を空白文字で接続し、「\」を「\\」に、「%」を「\%」に置換したもの
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられた全引数のさくらスクリプトをエスケープする。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  event.OnFileDropped : (
      $(escape ${System.Request.Reference0})
      がドロップされました。)
  # ドラッグ＆ドロップされたファイル名を表示する
</PRE>
</TD></TR>
</TABLE>

<A name="aux"></A>
<H4>4.2.9. コマンド-補助機能</H4>

<TABLE class="command" width="100%">
<CAPTION>
	entry<A name="entry"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(entry エントリ名 単語1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		${エントリ名}の結果、または単語1
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		エントリからランダムに単語を選び、評価する。
		指定したエントリが空の場合、単語1を返す。
		単語1は省略可能。省略した時に指定したエントリが空の場合、
		空文字を返す。<BR>
		evalでも同様のことが可能だが、entryの方が負荷が軽い。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  entry "npw";
  # ${npw}と同じ
  
  entry "message."$(rand 3);
  # ${message.0}から${message.2}のどれか
  
  entry "system.OtherGhost" ${myname};
  # ${system.OtherGhost}と同じ
  # 空の場合は${myname}の戻り値が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  entrycount<A name="entrycount"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(entrycount)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    エントリの総数
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    エントリの総数を返す。主にAIグラフに使用する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(entrycount)
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	eval<A name="eval"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(eval 単語1 ...)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		デコード結果
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		与えられた全引数中の${}、$()等を再度再帰的に評価し、
		展開結果を返す。再帰的評価を行う以外はechoと同じ。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  kawari     : 華和梨
  nise       : 偽
  shiori     : 栞
  niseshiori : ${nise}${shiori}
  
  =kis
  eval "理夢の偽AIは${kawari}です";
  # 「理夢の偽AIは華和梨です」が返る
  
  eval "奈留の偽AIは${niseshiori}です";
  # 「奈留の偽AIは偽栞です」が返る
  =end

参考
  =kis
  echo "奈留の偽AIは${niseshiori}です";
  # 「奈留の偽AIは${niseshiori}です」が返る
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	urllist<A name="urllist"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(urllist サイト名1 URL1 バナーURL1 ... サイト名n URLn バナーURLn)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		サイト名1[1]URL1[1]バナーURL1[2]...サイト名n[1]URLn[1]バナーURLn[2]<BR>
		※[1]はバイト値1、[2]はバイト値2
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		SHIORI/2.5規格に従い、「おすすめリスト」を生成する。
		引数の数は必ず3の倍数になること。<BR>
		仕切り線はサイト名に「-」を渡す。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  futaba : "http://futaba.mikage.to/"
  kawari : "http://meister-d-i.hoops.ne.jp/"

  # さくら側のおすすめサイトのリスト
  resource.sakura.recommendsites : $(
    urllist "ふたばみかげ" ${futaba} ${futaba}"banner.png"
    "何か以外の何か" ${kawari} ${kawari}"banner.png"
  )

  # うにゅう側のおすすめサイトのリスト
  resource.kero.recommendsites : (
    $(urllist "ふたばみかげ" "http://futaba.mikage.to/" "banner.png")
    $(urllist "-" "-" "-")
    $(urllist "何か以外の何か" "http://meister-d-i.hoops.ne.jp/" "banner.png")
  )
  # サイトごとにurllistコマンドを分けて書くことも出来る
  # 仕切り線の場合でも、ダミーのURLとバナーURLを与える必要がある
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  wordcount<A name="wordcount"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(wordcount)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    単語の総数
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    単語の総数を返す。主にAIグラフに使用する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(wordcount)
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  xargs<A name="xargs"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(xargs 引数エントリ コマンド1 ...)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    コマンド1の実行結果
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    引数エントリの内容を添え字順に展開して、コマンド1の引数として与える。
    コマンド1の後に書いた引数は、
    引数エントリの展開内容より前方に付加する。
    コマンド1の実行結果が戻り値となる。<BR>
    エントリ名の指定には、<A href="#dictcommon">辞書操作コマンド共通の書式</A>を利用できる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  SaveEntries : HighScore , Life , 喋り頻度 , 好感度 , 最終更新日
  
  RecommendSites : "伺か" , "http://sakura.mikage.to" , "-"
  RecommendSites : "まゆら" , "http://mayura.jp/" , "-"
  RecommendSites : "-" , "-" , "-"
  RecommendSites : "華和梨" , "http://kawari.sf.net/" , "-"
  
  keyword1 : 華和梨 , SHIORI , ゴースト
  
  =kis
  xargs SaveEntries save parameter.txt;
  # SaveEntriesの内容を展開してsaveコマンドを実行。
  # 「save parameter.txt HighScore Lige 喋り頻度 好感度 最終更新日」
  # を実行した場合と等価。
  
  xargs RecommendSites urllist;
  # urllistコマンドにRecommendSitesエントリの内容を展開して与える
  
  xargs keyword1 matchall ${System.Request.Reference0};
  # keyword1エントリの全ての単語がReference0にマッチしたら真を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<A name="othercmd"></A>
<H4>4.2.10. コマンド-その他</H4>

<TABLE class="command" width="100%">
<CAPTION>
	date<A name="date"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(date 書式文字列1 経過秒数1)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		日時の文字列
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		経過秒数1を1970/1/1 0:00:00からの経過秒数と考え、
		書式文字列1に従って、日時の情報を返す。
		経過秒数1は省略可能で、省略すると現時刻を指定したことになる。
		書式文字列には以下が使える。
		<UL>
		<TABLE border="0">
		<TR><TD>%d</TD><TD>: 日(2桁,01..31)</TD></TR>
		<TR><TD>%e</TD><TD>: 日(1..31)</TD></TR>
		<TR><TD>%H</TD><TD>: 時(2桁,00..23)</TD></TR>
		<TR><TD>%j</TD><TD>: 元日からの通算日(3桁,001..366)</TD></TR>
		<TR><TD>%J</TD><TD>: 元日からの通算日(1..366)</TD></TR>
		<TR><TD>%k</TD><TD>: 時(0..23)</TD></TR>
		<TR><TD>%m</TD><TD>: 月(2桁,01..12)</TD></TR>
		<TR><TD>%M</TD><TD>: 分(2桁,00..59)</TD></TR>
		<TR><TD>%n</TD><TD>: 月(1..12)</TD></TR>
		<TR><TD>%N</TD><TD>: 分(0..59)</TD></TR>
		<TR><TD>%r</TD><TD>: 秒(0..59)</TD></TR>
		<TR><TD>%S</TD><TD>: 秒(2桁,00..59)</TD></TR>
		<TR><TD>%s</TD><TD>: 1970/1/1 00:00:00(協定時)からの通算秒数</TD></TR>
		<TR><TD>%w</TD><TD>: 曜日(0..6,日曜日が0)</TD></TR>
		<TR><TD>%y</TD><TD>: 年(4桁,2000...)</TD></TR>
		<TR><TD>%Y</TD><TD>: 年(4桁,2000...)</TD></TR>
		</TABLE>
		</UL>
		'%'で始まるマクロ以外の文字は、そのまま表示する。
		また、書式文字列を省略した場合、
		「%y/%m/%d %H:%M:%S」をセットした場合と等価である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例1
  event.OnBoot : $(entry "time."$(date %H) )
  time.01 : 午前一時です\e
  time.02 : 午前二時です\e
  (中略)
  time.23 : 午後十一時です\e
  

例2
  event.OnFirstBoot : $(setstr 1stTime $(date %s) ; entry TalkFirstBoot)
  sentence : (
      \0\s[0]私が最初に起動したのは
      $(date %y ${1stTime})年の
      $(date %n ${1stTime})月
      $(date %e ${1stTime})日で、\w8\w8
      今日で$[ ($(date %s) - ${1stTime}) / (3600 * 24) ]日目です。\e
  )
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  debugger<A name="debugger"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
   $(debugger on)<BR>
   $(debugger off)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
   起動中のゴーストに、
   <A href="kosui.html">幸水</A>からの接続を許すかどうかを決める。
   引数に「on」を指定すると、接続可能になる。
   「off」を指定すると接続不可になる。
   接続可能な場合、
   <SPAN class="tt">System.Debugger</SPAN>エントリに「<SPAN class="tt">on</SPAN>」という文が定義される。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 幸水にてデバッグ中
  debugger on;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  getenv<A name="getenv"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
   $(getenv 環境変数名1)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    環境変数の内容
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    OSの環境変数の内容を返す。
    環境変数名1で指定した環境変数の内容を返す。
    指定した環境変数がなかった場合、ヌル文字を返す。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  $(getenv windir)
  # 環境変数windirが存在する場合、その内容を返す
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	help<A name="help"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(help コマンド名)<BR>
		$(help)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		リファレンスまたはコマンド一覧
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		コマンドが指定された場合は、リファレンスを返す。<BR>
		コマンドが指定されない場合は、使用可能なコマンドの一覧を返す。<BR>
		戻り値は"幸水"での出力を前提にしている。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例("幸水"での実行例)
  echo-mode > $(help help)
  help
  syntax  : help Command1
  return  : help message
  comment : return online help of KIS commnad (for Kosui use)
  echo-mode > $(help)
  Command list :
          echo
          set
      (・・・中略・・・)
          escape
  echo-mode >
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  logfile<A name="logfile"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(logfile ファイル名)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    ログを出力するファイルを設定する。
    <SPAN class="tt">"-"</SPAN>を設定すると標準出力になる(幸水など)。
    引数無しにすると、どこにも出力されない(デフォルト)。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 日付付きログファイルを作成
  logfile kawari-$(date %Y%m%d%H%M%S).log;
  
  # ログ禁止
  logfile;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  loglevel<A name="loglevel"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(loglevel キーワードの列挙)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    ログに出力する内容を決める。
    引数に列挙したキーワードに対応する内容が出力されるようになる。
    キーワードには以下がある。
    デフォルトではquietだが、
    現在、一部のログが設定を無視して出力されてしまう既知のバグあり。
    <TABLE border="0">
      <TR><TD>error</TD><TD>エラー</TD></TR>
      <TR><TD>warning</TD><TD>警告</TD></TR>
      <TR><TD>info</TD><TD>動作情報</TD></TR>
      <TR><TD>decl</TD><TD>空エントリへの読み出しアクセス</TD></TR>
      <TR><TD>paranoia</TD><TD>上記全て＋非常に詳しい動作情報</TD></TR>
      <TR><TD>baseevents</TD><TD>基本イベント</TD></TR>
      <TR><TD>timeevents</TD><TD>時刻(秒、分)イベント</TD></TR>
      <TR><TD>rscevents</TD><TD>リソース問い合わせイベント</TD></TR>
      <TR><TD>quiet</TD><TD>明確にログを禁止する</TD></TR>
    </TABLE>
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 通常デバッグ時には、これで十分
  loglevel error warning info baseevents;

  # まぁ、一度ぐらいは試してみてもいいです
  # 間違っても配布版でこれをやらないように
  loglevel paranoia baseevents;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  logprint<A name="logprint"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(logprint 単語 [ 単語 ... ])
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    ログに任意の文字列を出力する。
    引数に指定された全ての単語をスペースを挟んで連結し、出力する。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # いわゆるprintfデバッグ
  logprint ここまで動いた;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  mktime<A name="mktime"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(mktime 年 月 日 時 分 秒)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    1970/1/1 0:00:00(協定世界時)から指定時刻までに経過した秒数
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
    1970/1/1 0:00:00(協定世界時)から、引数で指定した時刻までに経過した秒数を返す。
    主に戻り値を$(date %s)の第2引数に与える。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 1970/1/1 0:00:00(UTC)から2005/4/1 0:30:25までに経過した秒数を返す
  mktime 2005 4 1 0 30 25;
  
  # 2001/1/25 1:00:00から1000日後の日付を求める
  # 1000日分をmktimeで求めた時刻に足して、dateの第2引数に与えている
  setstr @day $(mktime 2001 1 25 1 0 0);
  date "%y/%m/%d %H:%M:%S" $[ ${@day} + 1000 * 24 * 60 * 60 ];
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	rand<A name="rand"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(rand 上限)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		整数の文字列
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		0から上限の乱数を返す。戻り値は0を含み、上限を含まない。
		上限は負の数でもよい。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  rand 52;
  # 0から51までの乱数を返す
  
  rand -10;
  # 0から-9までの乱数を返す
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
  rccharset<A name="rccharset"></A>
</CAPTION>
<TR>
  <TD width="10%">書式</TD>
  <TD class="tt">
    $(rccharset 文字コード名)
  </TD>
</TR>
<TR>
  <TD>戻り値</TD>
  <TD>
    なし
  </TD>
</TR>
<TR>
  <TD>機能</TD>
  <TD>
   華和梨の出力するエラーメッセージの言語を、文字コードで指定する。
   指定する文字列は大文字、小文字を同一視する(case insensitive)。
   デフォルトは&quot;ISO-8859-1&quot;(いわゆる半角英文字、ほぼASCII)。
   それ以外には、現在の所、&quot;Shift_JIS&quot;だけが使える。
   対応していない文字コードを指定するとISO-8859-1になる。
  </TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 日本人ならやっぱり?
  rccharset Shift_JIS;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	securitylevel<A name="securitylevel"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(securitylevel レベル指定)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
	 セキュリティレベルを指定する。
	 以下の値を設定できる。
	 <TABLE border="0" cellpadding="2" cellspacing="0">
	  <TR><TD>0 / low</TD><TD> 全てのイベントを許可する。</TD></TR>
	  <TR><TD>1 / middle</TD><TD> 外部からやってきたイベントを禁止。</TD></TR>
	  <TR><TD>2 / high</TD><TD> 当面は1(middle)と同じ。</TD></TR>
	  <TR><TD>3 / ultrahigh</TD><TD>
	   明確にローカルマシン発行と記されたイベントのみ許可。
	  </TD></TR>
	 </TABLE>
	 なお、securitylevelコマンドは、ゴースト初期化中のみ、一回だけ実行可能である。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  # 低レベルに設定
  securitylevel low;
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	srand<A name="srand"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(srand シード)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		なし
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		乱数の種を設定する。主にデバッグ目的で使用する。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例
  =kis
  srand 12345678;
  # 乱数の種を「12345678」に設定する
  =end
</PRE>
</TD></TR>
</TABLE>

<TABLE class="command" width="100%">
<CAPTION>
	ver<A name="ver"></A>
</CAPTION>
<TR>
	<TD width="10%">書式</TD>
	<TD class="tt">
		$(ver 情報名)
	</TD>
</TR>
<TR>
	<TD>戻り値</TD>
	<TD>
		バージョン情報
	</TD>
</TR>
<TR>
	<TD>機能</TD>
	<TD>
		"華和梨"の情報を返す。「情報名」で欲しい情報を選択できる。<BR>
		情報名が「license」の場合、
		"華和梨"のライセンス情報をログに出力する。
		情報名が「author」の場合、
		"華和梨"の開発者情報を返す。
		情報名を省略した場合、"華和梨"のバージョン情報を返す。
		バージョン情報のフォーマットは「基本名称[.補助名称[.補助名称]]/バージョン番号」。
	</TD>
</TR>
<TR><TD colspan="2">
<PRE>
例("幸水"での実行例)
  echo-mode > $(ver)
  KAWARI.kdt/8.2.0
</PRE>
</TD></TR>
</TABLE>



<A name="appendix"></A>
<H2>Appendix</H2>

<A name="apdx1"></A>
<H3>I. インラインスクリプトの追加方法</H3>

<P>
インラインスクリプトの関数コマンドは、簡単に追加できるよう、華和梨の他の部分と
別のフォルダにソースが収めてあります。srcフォルダ中のkisフォルダがそれです。
自分で"華和梨"を拡張する際、KISの追加だけで望む機能が得られるか、まず検討して
下さい。この場合、華和梨のほかの機能へ与える影響が少なく、無用のエンバグを
避けられます。また、他の人がソースコードを再利用しやすくなるはずです。
</P><P>
KISコマンド追加の基本手順は以下の通りです。
</P>

<BLOCKQUOTE>
  0) ソースを書き換える前に、オリジナルのソースがMakeできるか確認する<BR>
  1) ソースコードのkis_echo.h/kis_echo.cppをよく読んで、参考にする<BR>
  2) 拡張するKISコマンドのヘッダファイルを用意する<BR>
	<UL>
     <LI>config.hとkis_base.hをincludeする</LI>
     <LI>TKisFunction_baseクラスをpublicに継承し、コマンドのクラスを作る</LI>
     <LI>INLINE_SCRIPT_REGIST()マクロを使い、コマンドのクラスを登録</LI>
     <LI>メンバ関数Initに簡単な解説を書く</LI>
     <LI>メンバ関数string Function(vector&lt;string&gt;&amp;)に処理を書く</LI>
	</UL>
  3) ヘッダファイル名をkis_config.hに追加する<BR>
  4) cppが増えた場合、必ずファイル名をfiles.makに追加しておく<BR>
  5) Make<BR>
</BLOCKQUOTE>

<P>
良いKISができたら、ぜひ教えてください。オリジナルの"華和梨"にも採用したいと思います。
</P>

<A name="apdx2"></A>
<H3>II. 注釈</H3>

<A name="ref1"></A>
<H4>*1 構文コマンドと関数コマンド</H4>
<P>
構文と関数の、実用上最も重要な違いは、
<UL>
<LI>構文の評価は引数評価以前に行われる
<LI>関数の評価は引数評価以後に行われる
</UL>
という点です。引数評価以前は、
引数は「${npw}」や「$(echo Hello)」等の「書いたまま」の状態です。
一方、引数評価以後は、引数は展開されて、
「カルロス・ゴーン」や「Hello」等の「文字列だけ」の状態となります。
引数が通常の文字列だけである場合はさほど問題になりませんが、
引数に<A href="#set">set</A>コマンド等の、
戻り値よりも機能が目的となるコマンドがあった場合、
この差が意味を持つことになります。
<!-- 構文の引数中か関数の引数中かで、コマンドが実行されるか否かが異なります。 -->
</P>

<PRE>
  true : 真です。$(set tmp OK)
  # 下記の二つは、表示上は恐らく同じ結果だが…
  $(entry true ${cond})      # true文はcondが不成立でも実行されてしまう。
  $(if ${cond} else ${true}) # true文はcondが不成立なら実行されない。
</PRE>

<A name="ref2"></A>
<H4>*2 インラインスクリプトに渡される引数の数</H4>
<P>
コマンドに引数を与える時、エントリ呼び出しで与える場合を考えます。

<PRE>
  $(echo $(entry ${EntryName}) "Hello")
</PRE>

<P>
このケースで、EntryNameエントリに何もセットされていない場合を考えます。
この場合、echoコマンドの第1引数は""で、第2引数が「Hello」になります。
第1引数が「Hello」ということはありません。
インラインスクリプトに渡される引数の数と位置は、エントリ解釈の前に確定します。
</P>

</BODY>
</HEAD>
</HTML>
